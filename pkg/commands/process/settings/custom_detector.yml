ruby_password_length:
  type: "risk"
  languages:
    - ruby
  patterns:
    - pattern: |
        class $<_> < ApplicationRecord
          validates :password, length: { minimum: $<LENGTH> }
        end
      filters:
        - variable: LENGTH
          minimum: 8
          match_violation: true
    - pattern: |
        class $<_> < ApplicationRecord
          devise password_length: $<MIN_LENGTH>..$<MAX_LENGTH>
        end
      filters:
        - variable: MAX_LENGTH
          minimum: 35
          match_violation: true
        - variable: MIN_LENGTH
          minimum: 8
          match_violation: true
    - pattern: |
        Devise.setup do |config|
          config.password_length = $<MIN_LENGTH>..$<MAX_LENGTH>
        end
      filters:
        - variable: MIN_LENGTH
          minimum: 8
          match_violation: true
    - pattern: |
        Devise.setup do |config|
          config.password_length = $<LENGTH>
        end
      filters:
        - variable: LENGTH
          minimum: 8
          match_violation: true
  detect_presence: true
ruby_http_get_detection:
  type: "risk"
  languages:
    - ruby
  patterns:
    - pattern: |
        URI.encode_www_form($<DATA_TYPE>)
    - filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        URI($<DATA_TYPE>)
    - filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        $<CLIENT:constant>.get($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
        - variable: CLIENT
          values:
            - Curl
            - Excon
            - Faraday
            - HTTP
            - HTTParty
            - HTTPX
            - RestClient
            - Typhoeus
  stored: false
ruby_http_post_detection:
  type: "risk"
  languages:
    - ruby
  patterns:
    - |
      URI.encode_www_form($<DATA_TYPE>)
    - |
      Net::HTTP.post_form($<DATA_TYPE>)
    - pattern: |
        $<CLIENT:constant>.post($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
        - variable: CLIENT
          values:
            - Curl
            - Excon
            - Faraday
            - HTTP
            - HTTParty
            - HTTPX
            - RestClient
            - Typhoeus
  stored: false
ruby_http_get_insecure:
  type: "risk"
  languages:
    - ruby
  patterns:
    - pattern: |
        URI($<INSECURE_URL>)
      filters:
        - variable: INSECURE_URL
          detection: insecure_url
    - pattern: |
        $<CLIENT:constant>.get($<INSECURE_URL>)
      filters:
        - variable: INSECURE_URL
          detection: insecure_url
        - variable: CLIENT
          values:
            - Curl
            - Excon
            - Faraday
            - HTTP
            - HTTParty
            - HTTPX
            - RestClient
            - Typhoeus
ruby_http_post_insecure:
  type: "risk"
  languages:
    - ruby
  patterns:
    - |
      Net::HTTP.post_form($<INSECURE_URL>)
    - pattern: |
        $<CLIENT:constant>.post($<INSECURE_URL>)
      filters:
        - variable: INSECURE_URL
          detection: insecure_url
        - variable: CLIENT
          values:
            - Curl
            - Excon
            - Faraday
            - HTTP
            - HTTParty
            - HTTPX
            - RestClient
            - Typhoeus
ruby_file_detection:
  type: "risk"
  languages:
    - ruby
  patterns:
    - pattern: |
        CSV.generate { $<DATA_TYPE> }
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        CSV.generate do
          $<DATA_TYPE>
        end
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        $<LIBRARY:constant>.open do
          $<DATA_TYPE>
        end
      filters:
        - variable: LIBRARY
          values:
            - CSV
            - File
        - variable: DATA_TYPE
          detection: datatype
  param_parenting: true
  metavars: {}
  stored: false
detect_ruby_logger:
  type: "risk"
  patterns:
    - pattern: |
        logger.info($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        Rails.logger.info($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - ruby
detect_rails_session:
  type: "risk"
  patterns:
    - pattern: |
        session[] = $<DATA_TYPE>
      filters:
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - ruby
detect_rails_jwt:
  type: "risk"
  patterns:
    - pattern: |
        JWT.encode($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - ruby
detect_rails_cookies:
  type: "risk"
  patterns:
    - pattern: |
        cookies[] = $<DATA_TYPE>
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: | # FIXME: either implement alternation, or have our own types that map to mulitple tree-sitter types
        cookies.$<METHOD_CHAIN:identifier|call>[] = $<DATA_TYPE>
      filters:
        - variable: METHOD_CHAIN
          values:
            - permanent
            - encrypted
            - signed
            - permanent.encrypted
            - permanent.signed
            - permanent.encrypted.signed
            - permanent.signed.encrypted
            - encrypted.permanent
            - encrypted.signed
            - encrypted.permanent.signed
            - encrypted.signed.permanent
            - signed.encrypted
            - signed.permanent
            - signed.permanent.encrypted
            - signed.encrypted.permanent
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - ruby
ssl_certificate_verification_disabled:
  type: "risk"
  patterns:
    - |
      Net::HTTP.start($<_>, $<_>, $<_>, :verify_mode => OpenSSL::SSL::VERIFY_NONE) do
      end
    - |
      Net::HTTP.start($<_>, $<_>, $<_>, verify_mode: OpenSSL::SSL::VERIFY_NONE) do
      end
    - |
      $<_>.verify_mode = OpenSSL::SSL::VERIFY_NONE
  languages:
    - ruby
detect_encrypted_ruby_class_properties:
  type: "verifier"
  patterns:
    - pattern: |
        class $<CLASS_NAME:constant> < ApplicationRecord
          encrypts $<DATA_TYPE>
        end
      filters: # FIXME: what to do with class name var?
        - variable: DATA_TYPE
          detection: datatype
  param_parenting: true
  root_singularize: true
  root_lowercase: true
  languages:
    - ruby
detect_sql_create_public_table:
  type: "data_type"
  patterns:
    - |
      CREATE TABLE public.$TABLE_NAME (
        <$COLUMN>
      )
    - |
      CREATE TABLE $TABLE_NAME (
        <$COLUMN>
      )
  param_parenting: true
  root_singularize: true
  root_lowercase: true
  languages:
    - sql
  stored: true
detect_rails_insecure_smtp:
  type: "risk"
  patterns:
    - |
      Rails.application.configure do
        config.action_mailer.smtp_settings = {
          openssl_verify_mode: OpenSSL::SSL::VERIFY_NONE
        }
      end
    - |
      Rails.application.configure do
        config.action_mailer.smtp_settings = {
          openssl_verify_mode: "none"
        }
      end
  languages:
    - ruby
  omit_parent: true
detect_rails_insecure_communication:
  type: "risk"
  patterns:
    - |
      Rails.application.configure do
        config.force_ssl = false
      end
  languages:
    - ruby
  omit_parent: true
detect_rails_insecure_ftp:
  type: "risk"
  patterns:
    - |
      Net::FTP.new()
    - |
      Net::FTP.open()
  languages:
    - ruby
detect_rails_insecure_ftp_data:
  type: "risk"
  patterns:
    - pattern: |
        Net::FTP.open do
          $<DATA_TYPE>
        end
      filters:
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - ruby
detect_ruby_third_party_data_send:
  type: "risk"
  patterns:
    - pattern: |
        Sentry::Breadcrumb.new($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        Sentry.init do |$<CONFIG:identifier>|
          $<CONFIG>.before_breadcrumb = lambda do |$<BREADCRUMB:identifier>, hint|
            $<BREADCRUMB>.message = $<DATA_TYPE>
          end
        end
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        Sentry.set_user($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - ruby
detect_ruby_weak_encryption:
  type: "risk"
  patterns:
    - pattern: |
        Digest::SHA1.hexidigest($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        Digest::MD5.hexdigest($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        OpenSSL::PKey::$<LIBRARY:constant>.new($<_>, $<DATA_TYPE>)
      filters:
        - variable: LIBRARY
          values:
            - DSA
            - RSA
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        RC4.new().encrypt($<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        OpenSSL::PKey::RSA.new($<_>, $<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        OpenSSL::PKey::RSA.new().$<METHOD:identifier>($<DATA_TYPE>)
      filters:
        - variable: METHOD
          values:
            - private_decrypt
            - private_encrypt
            - public_decrypt
            - public_encrypt
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        OpenSSL::PKey::DSA.new($<_>, $<DATA_TYPE>)
      filters:
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        OpenSSL::PKey::$<LIBRARY:constant>.new().$<METHOD:identifier>($<_>, $<DATA_TYPE>)
      filters:
        - variable: $LIBRARY
          values:
            - DSA
            - RSA
        - variable: METHOD
          values:
            - export
            - to_pem
            - to_s
        - variable: DATA_TYPE
          detection: datatype
    - pattern: |
        Crypt::Blowfish.new().encrypt_pair
      filters: []
    - pattern: |
        Crypt::Blowfish.new().$<METHOD:identifier>($<DATA_TYPE>)
      filters:
        - variable: METHOD
          values:
            - encrypt_pair
            - encrypt_string
            - encrypt_block
            - decrypt_pair
            - decrypt_string
            - decrypt_block
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - "ruby"
initialize_ruby_rc4_encryption:
  type: "risk"
  patterns:
    - |
      $<_> = RC4.new()
  languages:
    - "ruby"
initialize_ruby_openssl_pkey_dsa_encryption:
  type: "risk"
  patterns:
    - |
      $<_> = OpenSSL::PKey::DSA.new()
  languages:
    - "ruby"
initialize_ruby_openssl_pkey_rsa_encryption:
  type: "risk"
  patterns:
    - |
      $<_> = OpenSSL::PKey::RSA.new()
  languages:
    - "ruby"
initialize_ruby_blowfish_encryption:
  type: "risk"
  patterns:
    - |
      $<_> = Crypt::Blowfish.new()
  languages:
    - "ruby"
encrypt_method_call:
  type: "risk"
  patterns:
    - pattern: |
        $<_>.$<METHOD:identifier>($<DATA_TYPE>)
      filters:
        - variable: METHOD
          values:
            - encrypt
            - encrypt!
            - decrypt
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - "ruby"
ruby_openssl_pkey_method_call:
  type: "risk"
  patterns:
    - pattern: |
        $<_>.$<METHOD:identifier>($<DATA_TYPE>)
      filters:
        - variable: METHOD
          values:
            - export
            - to_pem
            - to_s
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - "ruby"
ruby_openssl_pkey_rsa_method_call:
  type: "risk"
  patterns:
    - pattern: |
        $<_>.$<METHOD:identifier>($<DATA_TYPE>)
      filters:
        - variable: METHOD
          values:
            - private_decrypt
            - private_encrypt
            - public_decrypt
            - public_encrypt
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - "ruby"
ruby_blowfish_method_call:
  type: "risk"
  patterns:
    - pattern: |
        $<_>.$<METHOD:identifier>($<DATA_TYPE>)
      filters:
        - variable: METHOD
          values:
            - encrypt_pair
            - encrypt_string
            - encrypt_block
            - decrypt_pair
            - decrypt_string
            - decrypt_block
        - variable: DATA_TYPE
          detection: datatype
  languages:
    - "ruby"
