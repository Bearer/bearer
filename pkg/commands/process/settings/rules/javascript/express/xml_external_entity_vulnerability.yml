patterns:
  - pattern: | # xml2js
      parseString($<EXPRESS_REQ>$<...>)
    filters:
      - variable: EXPRESS_REQ
        detection: javascript_express_xxe_vulnerability_request_obj
  - pattern: |
      $<XML2JS_PARSER>.$<METHOD>($<EXPRESS_REQ>$<...>)
    filters:
      - variable: XML2JS_PARSER
        detection: javascript_express_xxe_vulnerability_xml2js_parser
      - variable: EXPRESS_REQ
        detection: javascript_express_xxe_vulnerability_request_obj
      - variable: METHOD
        values:
          - parseString
          - parseStringPromise
  - pattern: |
      $<EXPAT_PARSER>.$<METHOD>($<EXPRESS_REQ>$<...>)
    filters:
      - variable: EXPAT_PARSER
        detection: javascript_express_xxe_vulnerability_node_expat_parser
      - variable: EXPRESS_REQ
        detection: javascript_express_xxe_vulnerability_request_obj
      - variable: METHOD
        values:
          - parse
          - write
  - pattern: |
      $<LIB_XML>.$<METHOD>(
        $<_>,
        {
          $<!>noent: true
        }
      )
    filters:
      - variable: LIB_XML
        values:
          - libxml
          - libxmljs
          - libxml2
          - libxml2js
      - variable: METHOD
        values:
          - parseXml
          - parseXmlString
  - pattern: | # xml2json
      parser.toXml($<EXPRESS_REQ>$<...>)
    filters:
      - variable: EXPRESS_REQ
        detection: javascript_express_xxe_vulnerability_request_obj
auxiliary:
  - id: javascript_express_xxe_vulnerability_request_obj
    patterns:
      - pattern: $<DATA>
        filters:
          - variable: DATA
            detection: javascript_express_xxe_vulnerability_user_input
      - pattern: const { $<!>$<_> } = $<DATA>
        filters:
          - variable: DATA
            detection: javascript_express_xxe_vulnerability_user_input
  - id: javascript_express_xxe_vulnerability_user_input
    patterns:
      - req.params
      - req.query
      - req.body
      - req.cookies
      - req.headers
  - id: javascript_express_xxe_vulnerability_node_expat_parser
    patterns:
      - new expat.Parser()
  - id: javascript_express_xxe_vulnerability_xml2js_parser
    patterns:
      - new xml2js.Parser()
languages:
  - javascript
severity: high
metadata:
  description: "XML External Entity vulnerability detected."
  remediation_message: |
    ## Description
    Avoid parsing untrusted data as XML. Such data could include URIs that resolve to resources that are outside of the current context, leading to XML External Entity (XXE) injection.

    ## Remediations
    ‚ùå Do not enable parsing of external entities.

    For LibXML, for example, do not set `noent` to `true`.
    ```javascript
      var libxml = require("libxmljs");
      libxml.parseXmlString(xml, { noent: true, noblanks: true });
    ```

    ## Resources
    - [OWASP XML External Entity (XXE) prevention cheat sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
  cwe_id:
    - 611
  id: "javascript_express_xxe_vulnerability"
